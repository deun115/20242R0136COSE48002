# MobileNet 플러터 적용 실험

사용 모델 : MobileNet medium  
모델 내보내기 형식 : onnx

## 이미지 전처리 과정

모델 입력 전 이미지 전처리 과정을 거쳐야 합니다.  
파이썬에서 실행할때는 다음과 같은 전처리 과정을 거치게 됩니다.

```
val_transform = transforms.Compose([
    transforms.Resize(image_resize),
    transforms.CenterCrop(input_size),
    transforms.ToTensor(),
    transforms.Normalize(mean=mean, std=std),
])
```

PyTorch 기반 모델은 채널 우선 순서(C, H, W)를 사용하지만, 플러터의 이미지 데이터는 높이 우선 순서(H, W, C)로 계산이 됩니다.  
따라서 플러터에서는 조금 다른 전처리 과정을 거치게 됩니다.  
`HomeViewModel`의 `preprocessImage()` 함수가 이에 맞게 이미지 전처리하는 과정을 진행합니다.

## 실제 모바일 기기 테스트

갤럭시 S22, 갤럭시 S23+ 기종으로 실험을 진행했습니다.  
5개의 이미지에 대해서 모델 load 시간, 예측 시간, 예측 시 GPU 사용량을 측정했습니다.

### 모델 실행 시간 (load time)

모델이 실행되고 준비되는데 까지 걸리는 시간(ms)을 측정했습니다.

**갤럭시 S22**
| Trial 1 | Trial 2 | Trial 3 | Trial 4 | Trial 5 | Avg |
| ------- | ------- | ------- | ------- | ------- | ----- |
| 752 | 703 | 721 | 707 | 695 | 715.6 |

**갤럭시 S23+**
| Trial 1 | Trial 2 | Trial 3 | Trial 4 | Trial 5 | Avg |
| --- | --- | --- | --- | --- | --- |
| 561 | 551 | 530 | 529 | 536 | 541.4 |

### 예측 시간 (latency)

5개의 육류 이미지로 예측에 걸리는 시간(ms)을 측정했습니다.  
갤럭시 S22와 갤럭시 S23+ 두 기기 모두 1초 이내로 예측이 완료되는 것을 확인했습니다.

**갤럭시 S22: 평균 887.58 ms**

|         | Image 1 | Image 2 | Image 3 | Image 4 | Image 5 |
| ------- | ------- | ------- | ------- | ------- | ------- |
| Trial 1 | 928     | 779     | 814     | 760     | 801     |
| Trial 2 | 953     | 960     | 956     | 837     | 899     |
| Trial 3 | 962     | 898     | 924     | 852     | 893     |
| Trial 4 | 915     | 879     | 916     | 858     | 853     |
| Trial 5 | 949     | 948     | 923     | 837     | 893     |
| min     | 915     | 779     | 814     | 760     | 801     |
| max     | 962     | 960     | 956     | 858     | 899     |
| avg     | 941.4   | 892.8   | 906.6   | 828.8   | 867.8   |

**갤럭시 S23+: 평균 679.84 ms**

|         | Image 1 | Image 2 | Image 3 | Image 4 | Image 5 |
| ------- | ------- | ------- | ------- | ------- | ------- |
| Trial 1 | 828     | 678     | 718     | 642     | 678     |
| Trial 2 | 808     | 672     | 693     | 640     | 661     |
| Trial 3 | 680     | 677     | 698     | 625     | 686     |
| Trial 4 | 678     | 676     | 688     | 639     | 660     |
| Trial 5 | 666     | 664     | 667     | 618     | 656     |
| min     | 666     | 664     | 667     | 618     | 656     |
| max     | 828     | 678     | 718     | 640     | 686     |
| avg     | 732     | 673.4   | 692.8   | 632.8   | 668.2   |

### GPU 사용량

모델 예측 시 사용되는 GPU 점유율을 측정했습니다.

**갤럭시 S22**: 3~5%  
**갤럭시 S23+**: 4~6%
